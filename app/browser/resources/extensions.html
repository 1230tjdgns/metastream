<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Extensions</title>
  <link rel="stylesheet" href="../../styles/app.global.css">
  <link rel="stylesheet" href="../../styles/resource.global.css">
  <style>
    .ext-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 15px;
    }

    .ext-item:last-child {
      margin: 0;
    }

    .ext-icon {
      width: 38px;
      height: 38px;
    }

    .ext-meta {
      display: flex;
      flex: 1 1 auto;
      flex-direction: column;
      padding: 0 15px;
    }

    .ext-name {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
  <script>
    (function () {
      const { ipcRenderer } = chrome;
      let $

      const findOrCreateExtElem = id => {
        let elem = document.querySelector(`[data-extension-id=${id}]`)
        if (elem) return elem

        const node = document.importNode($.template.content, true)
        elem = node.firstElementChild
        elem.dataset.extensionId = id
        $.list.appendChild(elem)

        return elem
      }

      ipcRenderer.on('extensions-status', (e, list) => {
        console.debug('Extensions status', list)
        list.forEach(ext => {
          setupExtension(ext)
          updateExtension(ext.id, ext.enabled)
        })
      })

      function updateExtension(id, enabled) {
        const toggle = findOrCreateExtElem(id).querySelector('.tgl')
        toggle.checked = enabled
      }

      function setupExtension(ext) {
        const { id } = ext
        const elem = findOrCreateExtElem(id)
        if (elem.__init) return

        elem.querySelector('.ext-name').innerText = ext.name || id
        elem.querySelector('.ext-desc').innerText = ext.desc || ''

        if (ext.icons) {
          const basePath = ext.base_path.replace('file:///', 'chrome://brave/')
          const icon = ext.icons['128'] || ext.icons['64'] || ext.icons['48']
          elem.querySelector('.ext-icon').src = `${basePath}/${icon}`
        }

        const toggle = elem.querySelector('.tgl')
        const toggleBtn = elem.querySelector('.tgl-btn')
        toggleBtn.addEventListener('click', (e) => {
          const enabled = toggle.checked
          const eventName = enabled ? 'extensions-remove' : 'extensions-install'
          ipcRenderer.send(eventName, id)
        })

        elem.__init = true
      }

      function init() {
        console.log('Initializing...')
        const q = document.querySelector.bind(document)

        $ = {
          template: q('#ext-template'),
          list: q('#ext-list')
        }

        ipcRenderer.send('extensions-status')
      }
      document.addEventListener('DOMContentLoaded', init)
    }())
  </script>
</head>

<body>

  <main class="container">
    <h1 class="header">Extensions</h1>
    <section id="ext-list">
    </section>
  </main>

  <template id="ext-template">
    <div class="ext-item" data-extension-id="cjpalhdlnbpafiamejdnhcphjbkeiagm">
      <img class="ext-icon" src="../../assets/img/extensions/ublock.svg">
      <div class="ext-meta">
        <div class="ext-name">uBlock Origin</div>
        <div class="ext-desc">Finally, an efficient blocker. Easy on CPU and memory.</div>
      </div>
      <input id="toggle" class="ext-toggle tgl tgl-light" type="checkbox">
      <label class="tgl-btn" for="toggle">
    </div>
  </template>

</body>

</html>
